---
import Layout from "../../layouts/Layout.astro";
import type { Frontmatter } from "../../types";
import dayjs from "dayjs";
import type { MarkdownInstance } from "astro";

interface Post {
  url?: string;
  title: string;
  date: dayjs.Dayjs;
  noDay: boolean;
  minutesRead: string;
  tags: string[];
}
let byYear = (await Astro.glob<MarkdownInstance<Frontmatter>>("./**/*.md*"))
  .map((post) => {
    return {
      url: post.url,
      title: post.frontmatter.title,
      date: dayjs(post.frontmatter.date),
      noDay: post.frontmatter.date.split(" ").length <= 2,
      minutesRead: post.frontmatter.minutesRead,
      tags: post.frontmatter.tags ?? [],
    };
  })
  .reduce<{ [year: string]: Post[] }>((byYear, post) => {
    let year = post.date.get("year").toString();
    if (byYear[year]) {
      byYear[year].push(post);
    } else {
      byYear[year] = [post];
    }
    return byYear;
  }, {});

for (const years in byYear) {
  byYear[years] = byYear[years].sort((a, b) => b.date.unix() - a.date.unix());
}

let years = [2022, 2021, 2020, 2019];
---
<Layout title="Enoch - Blog" activeNav="blog">
  {
  years.map((year) => (
  <>
    <h1>{year}</h1>
    {byYear[year].map((post) => (
    <div class="post">
      <h4 class="title">
        <a href={post.url}>{post.title}</a>
      </h4>
      <section>
        <p class="date">
          {post.date.format(post.noDay ? "MMMM" : "MMMM DD")}
          <span class="readtime">{post.minutesRead}</span>
        </p>
        <p class="tags-container">
          {post.tags?.map((tag) => (
          <>
            <span class="tag">{tag}</span>{" "}
          </>
          ))}
        </p>
          
      </section>
    </div>
    ))}
  </>
  ))
  }
</Layout>

<style lang="scss">
  h1 {
    margin: 1.25rem 0 0.4rem 0;
  }

  .post {
    margin-bottom: 0.5rem;

    section {}

    .title {
      line-height: 1.4;
    }
  }

  .readtime {
    color: var(--grey);
  }

  .tags-container {
    margin-top: 0.3rem;
  }

  .tag {
    border-radius: var(--border-radius);
    padding: 0rem 0.2rem;
    background: var(--grey);
    color: var(--primary);
  }
</style>
